{"version":3,"sources":["../../../../../../packages/coso-factory-ui/src/builder-ui.tsx","../../../../../../apps/nevedelE/lib/edition-json.ts"],"sourcesContent":["\"use client\";\nimport { useMemo, useState } from \"react\";\nimport { normalizeEditionJsonForBuilder, validateEditionJson } from \"../../../apps/nevedelE/lib/edition-json\";\nimport type { EditionIndexEntry } from \"./types\";\n\nfunction buildPrompt(existingSlugs: string[]) {\n  const deployed = existingSlugs.map((s) => `- ${s}`).join(\"\\n\");\n\n  // Canonical production prompt (matches current validator/model).\n  // Generates tasks as 5 categories with pool of task objects (id/title/metricKey/variants).\n  const base = [\n    \"ROLE: Si generator edicii pre COSO Factory (Next.js app).\",\n    \"\",\n    \"VYSTUP:\",\n    \"- Vrat presne 1 JSON objekt (ziadny markdown, ziadne komentare, ziadny dalsi text).\",\n    \"- Musi to byt strict JSON (dvojite uvodzovky, ziadne trailing commas).\",\n    \"\",\n    \"CIEĽ:\",\n    \"- Vymysli novu koherentnu ediciu (tema, nazov, texty, tasky).\",\n    \"- Musi to byt prakticke, bezpecne, pouzitelne ako denny sebareflexny nastroj.\",\n    \"\",\n    \"KONTEXT PRODUKTU:\",\n    \"- Edicia je stranka na /e/<slug>.\",\n    \"- Pouzivatel moze zadat meno a birthDate (YYYY-MM-DD) ako volitelne vstupy.\",\n    \"- Full vysledok je za paywallom; bez platby je len teaser.\",\n    \"\",\n    \"HARD REQUIREMENTS:\",\n    \"1) slug: lowercase-hyphen, 3-64 znakov, musi byt unikatny a NESMIE byt v zozname uz nasadenych slugov nizsie.\",\n    \"2) engine.locale = \\\"sk\\\"\",\n    \"3) engine.subject: snake_case, 3-40 znakov, tematicky suvisiace s ediciou.\",\n    \"4) content: vypln vsetky polia realnym textom (ziadne \\\"...\\\").\",\n    \"5) tasks:\",\n    \"- pickPerCategory musi byt 3\",\n    \"- categories musi byt presne 5 poloziek\",\n    \"- kazda kategoria musi mat pool presne 30 task objektov\",\n    \"- kazdy task objekt musi mat: id, title, metricKey, variants\",\n    \"- variants musi byt presne 3 prvky v tomto tvare:\",\n    \"  (1) { when: { lte: 33 }, text: \\\"...\\\" }\",\n    \"  (2) { when: { between: [34,66] }, text: \\\"...\\\" }\",\n    \"  (3) { when: { gte: 67 }, text: \\\"...\\\" }\",\n    \"\",\n    \"AKO TO NAVRHNUT, ABY TO DAVALO ZMYSEL:\",\n    \"- Zvol jednu jasnu temu (napr. fokus, hranice, komunikacia, regeneracia, rozhodovanie).\",\n    \"- Navrhni 5 kategorii, ktore spolu tvoria model (napr. Fokus, Energia, Hranice, Komunikacia, Obnova).\",\n    \"- Pre kazdu kategoriu vytvor 30 mikro-uloch (konkretne, vykonatelne, bezpecne).\",\n    \"- Pre kazdu ulohu napis 3 varianty textu podla skore:\",\n    \"  lte (nizke skore): jemny start, minimal effort.\",\n    \"  between (stred): udrziavaci krok, male zlepsenie.\",\n    \"  gte (vysoke): narocnejsi/preciznejsi krok bez tlaku.\",\n    \"- metricKey rob konzistentne: m_catX_tYY (napr. m_cat3_t14).\",\n    \"\",\n    \"BEZPECNOST:\",\n    \"- Bez medicinskych diagnoz, bez terapeutickych tvrdeni, bez nelegalnych navodov.\",\n    \"\",\n    \"JSON SCHEMA (MUSI SEDIT S KLUCAMI):\",\n    \"{\",\n    \"  \\\"slug\\\": \\\"...\\\",\",\n    \"  \\\"title\\\": \\\"...\\\",\",\n    \"  \\\"engine\\\": { \\\"subject\\\": \\\"...\\\", \\\"locale\\\": \\\"sk\\\" },\",\n    \"  \\\"content\\\": {\",\n    \"    \\\"heroTitle\\\": \\\"...\\\",\",\n    \"    \\\"heroSubtitle\\\": \\\"...\\\",\",\n    \"    \\\"intro\\\": { \\\"title\\\": \\\"...\\\", \\\"text\\\": \\\"...\\\" },\",\n    \"    \\\"form\\\": {\",\n    \"      \\\"title\\\": \\\"...\\\",\",\n    \"      \\\"nameLabel\\\": \\\"Meno (volitelne)\\\",\",\n    \"      \\\"birthDateLabel\\\": \\\"Datum narodenia (volitelne)\\\",\",\n    \"      \\\"submitLabel\\\": \\\"Vyhodnotit\\\"\",\n    \"    },\",\n    \"    \\\"result\\\": {\",\n    \"      \\\"teaserTitle\\\": \\\"...\\\",\",\n    \"      \\\"teaserNote\\\": \\\"...\\\",\",\n    \"      \\\"unlockHint\\\": \\\"...\\\"\",\n    \"    },\",\n    \"    \\\"paywall\\\": {\",\n    \"      \\\"headline\\\": \\\"...\\\",\",\n    \"      \\\"bullets\\\": [\\\"...\\\", \\\"...\\\", \\\"...\\\"],\",\n    \"      \\\"cta\\\": \\\"Pokracovat na platbu\\\"\",\n    \"    }\",\n    \"  },\",\n    \"  \\\"tasks\\\": {\",\n    \"    \\\"pickPerCategory\\\": 3,\",\n    \"    \\\"categories\\\": [\",\n    \"      {\",\n    \"        \\\"key\\\": \\\"cat-1\\\",\",\n    \"        \\\"title\\\": \\\"...\\\",\",\n    \"        \\\"pool\\\": [\",\n    \"          {\",\n    \"            \\\"id\\\": \\\"t1-01\\\",\",\n    \"            \\\"title\\\": \\\"...\\\",\",\n    \"            \\\"metricKey\\\": \\\"m_cat1_t01\\\",\",\n    \"            \\\"variants\\\": [\",\n    \"              { \\\"when\\\": { \\\"lte\\\": 33 }, \\\"text\\\": \\\"...\\\" },\",\n    \"              { \\\"when\\\": { \\\"between\\\": [34, 66] }, \\\"text\\\": \\\"...\\\" },\",\n    \"              { \\\"when\\\": { \\\"gte\\\": 67 }, \\\"text\\\": \\\"...\\\" }\",\n    \"            ]\",\n    \"          }\",\n    \"        ]\",\n    \"      },\",\n    \"      { \\\"key\\\": \\\"cat-2\\\", \\\"title\\\": \\\"...\\\", \\\"pool\\\": [ /* 30 task objects */ ] },\",\n    \"      { \\\"key\\\": \\\"cat-3\\\", \\\"title\\\": \\\"...\\\", \\\"pool\\\": [ /* 30 task objects */ ] },\",\n    \"      { \\\"key\\\": \\\"cat-4\\\", \\\"title\\\": \\\"...\\\", \\\"pool\\\": [ /* 30 task objects */ ] },\",\n    \"      { \\\"key\\\": \\\"cat-5\\\", \\\"title\\\": \\\"...\\\", \\\"pool\\\": [ /* 30 task objects */ ] }\",\n    \"    ]\",\n    \"  }\",\n    \"}\",\n    \"\",\n    \"FINAL SELF-CHECK (sprav potichu pred vystupom):\",\n    \"- slug je unikatny vs deployed list?\",\n    \"- categories ma presne 5?\",\n    \"- pickPerCategory je 3?\",\n    \"- kazda kategoria ma pool presne 30?\",\n    \"- kazdy task ma variants presne 3 s lte/between/gte?\",\n    \"- ziaden placeholder \\\"...\\\" vo finalnom JSON?\",\n    \"\",\n    \"Already deployed editions (MUST AVOID):\",\n    deployed || \"- (none)\"\n  ].join(\"\\n\");\n\n  return base;\n}\n\nexport default function BuilderClient({ editions }: { editions: EditionIndexEntry[] }) {\n  const [existingSlugs, setExistingSlugs] = useState<string[]>(editions.map((e) => e.slug));\n  const basePrompt = useMemo(() => buildPrompt(existingSlugs), [existingSlugs]);\n  const [prompt, setPrompt] = useState(basePrompt);\n  const [editionJson, setEditionJson] = useState(\"\");\n  const [status, setStatus] = useState<{ kind: \"idle\" | \"ok\" | \"err\"; msg: string }>({ kind: \"idle\", msg: \"\" });\n\n  async function onCopyPrompt() {\n    try {\n      await navigator.clipboard.writeText(prompt);\n      setStatus({ kind: \"ok\", msg: \"Prompt copied.\" });\n    } catch {\n      setStatus({ kind: \"err\", msg: \"Copy failed.\" });\n    }\n  }\n\n  async function onRefreshSlugs() {\n    setStatus({ kind: \"idle\", msg: \"Starting factory workflow...\" });\n    try {\n      const res = await fetch(\"/api/editions/slugs\", { cache: \"no-store\" });\n      const data = await res.json().catch(() => null);\n\n      if (!res.ok || !data?.ok || !Array.isArray(data?.slugs)) {\n        setStatus({ kind: \"err\", msg: `Refresh failed: ${data?.error ?? res.status}`.trim() });\n        return;\n      }\n\n      const slugs = data.slugs.map((x: any) => String(x)).filter(Boolean);\n      setExistingSlugs(slugs);\n      setPrompt(buildPrompt(slugs));\n      setStatus({ kind: \"ok\", msg: `Refresh OK. Slugs loaded: ${slugs.length}` });\n    } catch {\n      setStatus({ kind: \"err\", msg: \"Refresh failed.\" });\n    }\n  }\n\n  async function onDispatch() {\n    const v = validateEditionJson(editionJson, existingSlugs);\n    if (!v.ok) {\n      const dbg = (v as any)?.debug ?? {};\n      const keys = Array.isArray(dbg.foundRootKeys) ? dbg.foundRootKeys : [];\n      const norm = String(dbg.normalizedStart ?? \"\").replace(/\\s+/g, \" \").trim();\n      setStatus({\n        kind: \"err\",\n        msg: `Neplatny JSON: ${v.error}${v.details ? ` (${v.details})` : \"\"}; root keys: ${keys.join(\", \") || \"(none)\"}; normalized head: ${norm}`,\n      });\n      return;\n    }\n\n    setStatus({ kind: \"idle\", msg: \"Starting factory workflow...\" });\n\n    const res = await fetch(\"/api/factory/dispatch\", {\n      method: \"POST\",\n      headers: { \"content-type\": \"application/json\" },\n      body: JSON.stringify({ edition: v.obj, rawEditionJson: editionJson }),\n    });\n\n    const data = await res.json().catch(() => null);\n    if (!res.ok || !data?.ok) {\n      setStatus({ kind: \"err\", msg: `Dispatch zlyhal: ${data?.error ?? res.status} ${data?.message ?? \"\"}`.trim() });\n      return;\n    }\n\n    const okMsg =\n      typeof data?.message === \"string\" && data.message.trim()\n        ? data.message.trim()\n        : `OK. Edition saved to repo. slug=${String(data?.slug ?? \"\").trim()}`;\n\n    setStatus({ kind: \"ok\", msg: okMsg });\n    setEditionJson(\"\");\n  }\n\n  return (\n    <main\n      className=\"min-h-screen px-4 py-10 text-neutral-100\"\n      style={{\n        backgroundImage: \"url(/brand/bg.png)\",\n        backgroundSize: \"cover\",\n        backgroundPosition: \"center\",\n        backgroundRepeat: \"no-repeat\",\n      }}\n    >\n      <div className=\"mx-auto w-full max-w-4xl translate-y-6 rounded-2xl border border-neutral-800 bg-neutral-900/70 p-6 shadow-xl backdrop-blur\">\n        <div className=\"mb-6 flex justify-center\">\n          <img src=\"/brand/logo.png\" alt=\"Brand\" style={{ height: 120, width: \"auto\" }} />\n        </div>\n\n        <h1 className=\"text-3xl font-semibold tracking-tight\">Factory Builder</h1>\n        <p className=\"mt-2 text-sm leading-6 text-neutral-200/80\">Prompt and list of editions (slugs) are used as input context.</p>\n\n        <section className=\"mt-8 space-y-2\">\n          <h2 className=\"text-xl font-semibold\">1) Prompt pre LLM</h2>\n          <textarea\n            value={prompt}\n            onChange={(e) => setPrompt(e.target.value)}\n            rows={18}\n            className=\"w-full rounded-xl border border-neutral-700 bg-neutral-950/80 p-3 font-mono text-sm leading-6 outline-none focus:border-neutral-500\"\n          />\n          <div className=\"mt-2 flex flex-wrap gap-3\">\n            <button className=\"rounded-lg bg-neutral-100 px-3 py-2 text-sm font-semibold text-neutral-950\" onClick={onCopyPrompt}>\n              Copy prompt\n            </button>\n            <button className=\"rounded-lg bg-neutral-100 px-3 py-2 text-sm font-semibold text-neutral-950\" onClick={onRefreshSlugs}>\n              Refresh\n            </button>\n            <button className=\"rounded-lg bg-neutral-100 px-3 py-2 text-sm font-semibold text-neutral-950\" onClick={() => setPrompt(basePrompt)}>\n              Reset prompt\n            </button>\n            <a href=\"/list\" className=\"rounded-lg border border-neutral-200/40 bg-neutral-950/30 px-3 py-2 text-sm text-neutral-100\">\n              View deployed editions\n            </a>\n          </div>\n        </section>\n\n        <section className=\"mt-8 space-y-2\">\n          <h2 className=\"text-xl font-semibold\">2) Paste LLM JSON and build the edition</h2>\n          <textarea\n            value={editionJson}\n            onChange={(e) => setEditionJson(e.target.value)}\n            rows={12}\n            placeholder='You can paste plain JSON, a `json ... ` block, or text that contains a JSON object.'\n            className=\"w-full rounded-xl border border-neutral-700 bg-neutral-950/80 p-3 font-mono text-sm leading-6 outline-none focus:border-neutral-500\"\n          />\n          <div className=\"mt-2 flex flex-wrap gap-3\">\n            <button\n              className=\"rounded-lg bg-neutral-100 px-3 py-2 text-sm font-semibold text-neutral-950\"\n              onClick={() => {\n                const v = validateEditionJson(editionJson, existingSlugs);\n                setStatus(v.ok ? { kind: \"ok\", msg: \"JSON looks valid.\" } : { kind: \"err\", msg: `Invalid JSON: ${v.error}` });\n              }}\n            >\n              Validate\n            </button>\n            <button className=\"rounded-lg bg-emerald-300 px-3 py-2 text-sm font-semibold text-emerald-950\" onClick={onDispatch}>\n              Dispatch build\n            </button>\n            <button\n              className=\"rounded-lg border border-neutral-200/40 bg-neutral-950/30 px-3 py-2 text-sm text-neutral-100\"\n              onClick={() => {\n                const n = normalizeEditionJsonForBuilder(editionJson);\n                setEditionJson(n);\n                setStatus({ kind: \"ok\", msg: `JSON normalized (${n.length} chars). Missing title/slug/content were auto-filled.` });\n              }}\n            >\n              Normalize JSON\n            </button>\n          </div>\n\n          {status.msg && (\n            <p\n              className={`mt-3 rounded-xl border p-3 text-sm ${\n                status.kind === \"err\"\n                  ? \"border-red-500 text-red-200\"\n                  : status.kind === \"ok\"\n                    ? \"border-green-500 text-green-200\"\n                    : \"border-neutral-200/40 text-neutral-100\"\n              } bg-neutral-950/40`}\n            >\n              <strong>{status.kind === \"err\" ? \"Error\" : status.kind === \"ok\" ? \"OK\" : \"Info\"}:</strong> {status.msg}\n            </p>\n          )}\n        </section>\n      </div>\n    </main>\n  );\n}\r\n","export type EditionPayload = {\n  slug: string;\n  title: string;\n  content: Record<string, any>;\n  [k: string]: any;\n};\n\n// ---- task V2 normalization (builder-friendly) ----\nfunction toAsciiSafe(s: string) {\n  // keep original text as-is; but ensure it's a string and trim\n  return String(s ?? \"\").trim();\n}\n\nfunction mkId(prefix: string, n: number) {\n  return `${prefix}-${String(n).padStart(3,\"0\")}`;\n}\n\nfunction mkMetricKey(catIndex: number, taskIndex: number) {\n  return `c${catIndex+1}_t${taskIndex+1}`;\n}\n\nfunction ensure3Variants(title: string, variants: any) {\n  const base = toAsciiSafe(title) || \"Task\";\n  let v = Array.isArray(variants) ? variants.map(toAsciiSafe).filter(Boolean) : [];\n  if(v.length === 0){\n    v = [\n      base,\n      base + \" (quick)\",\n      base + \" (deep)\"\n    ];\n  }\n  // pad / trim to exactly 3\n  while(v.length < 3) v.push(v[v.length-1]);\n  if(v.length > 3) v = v.slice(0,3);\n  return v;\n}\n\nfunction ensureTaskV2(catIndex: number, taskIndex: number, t: any) {\n  // Accept:\n  // - string => convert\n  // - object => fill missing fields, fix variants length\n  if(typeof t === \"string\"){\n    const title = toAsciiSafe(t);\n    return {\n      id: mkId(`c${catIndex+1}t${taskIndex+1}`, 1),\n      title,\n      metricKey: mkMetricKey(catIndex, taskIndex),\n      variants: ensure3Variants(title, null),\n    };\n  }\n  const title = toAsciiSafe(t?.title ?? t?.name ?? t?.text ?? \"\");\n  return {\n    id: toAsciiSafe(t?.id) || mkId(`c${catIndex+1}t${taskIndex+1}`, 1),\n    title: title || \"Task\",\n    metricKey: toAsciiSafe(t?.metricKey) || mkMetricKey(catIndex, taskIndex),\n    variants: ensure3Variants(title || \"Task\", t?.variants),\n  };\n}\n\nfunction normalizeTasksToV2(edition: any) {\n  if(!edition?.tasks?.categories || !Array.isArray(edition.tasks.categories)) return edition;\n  edition.tasks.categories = edition.tasks.categories.map((c: any, ci: number) => {\n    const title = toAsciiSafe(c?.title ?? `Category ${ci+1}`) || `Category ${ci+1}`;\n    const tasksRaw = Array.isArray(c?.tasks) ? c.tasks : [];\n    const tasks = tasksRaw.map((t: any, ti: number) => ensureTaskV2(ci, ti, t));\n    return { ...c, title, tasks };\n  });\n  return edition;\n}\n// ---- end task V2 normalization ----\n\nfunction sanitizeRaw(raw: string) {\n  return String(raw ?? \"\")\n    .replace(/^\\uFEFF/, \"\")\n    .replace(/[\\u0300-\\u036f]/g, \"\")\n    .trim();\n}\n\nfunction unwrapCodeFence(input: string) {\n  const fence = input.match(/^```(?:json)?\\s*\\n([\\s\\S]*?)\\n```$/i);\n  return fence ? fence[1].trim() : input;\n}\n\nfunction extractJSONObject(input: string) {\n  const start = input.indexOf(\"{\");\n  const end = input.lastIndexOf(\"}\");\n  if (start === -1 || end === -1 || end <= start) return input;\n  return input.slice(start, end + 1);\n}\n\nfunction slugify(input: string) {\n  const base = String(input || \"\")\n    .toLowerCase()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\")\n    .replace(/[^a-z0-9]+/g, \"-\")\n    .replace(/^-+|-+$/g, \"\");\n  const clipped = base.slice(0, 64);\n  if (/^[a-z0-9][a-z0-9-]{1,62}[a-z0-9]$/.test(clipped)) return clipped;\n  return \"generated-edition\";\n}\n\nfunction normalizeGroupsFixture(out: any) {\n  if (!Array.isArray(out?.groups) || out?.tasks) return out;\n\n  const groups = out.groups.filter((g: any) => typeof g === \"string\" && g.trim());\n  const baseTasks = Array.isArray(out?.tasks) ? out.tasks : [];\n\n  out.categories = groups.map((g: string, idx: number) => ({\n    id: `cat-${idx + 1}`,\n    title: g,\n    tasks: baseTasks,\n  }));\n\n  return out;\n}\n\nfunction fallbackContent(title: string) {\n  return {\n    heroTitle: title,\n    heroSubtitle: \"Personalizovaný prehľad\",\n    intro: { title: \"Úvod\", text: \"Vyplň krátky formulár a získaj výsledok.\" },\n    form: { title: \"Vyhodnotenie\", nameLabel: \"Meno\", birthDateLabel: \"Dátum narodenia\", submitLabel: \"Vyhodnotiť\" },\n    result: { teaserTitle: \"Náhľad\", teaserNote: \"Zobrazený je len teaser.\", unlockHint: \"Odomkni celý výsledok.\" },\n    paywall: {\n      headline: \"Odomkni celý výsledok\",\n      bullets: [\"Všetky kategórie\", \"Plný text\", \"Personalizované výstupy\"],\n      cta: \"Pokračovať na platbu\",\n    },\n  };\n}\n\nfunction normalizeFixture(obj: any) {\n  const out = normalizeGroupsFixture({ ...obj });\n\n  if (!out.tasks && Array.isArray(out.categories)) {\n    out.tasks = {\n      pickPerCategory: 3,\n      categories: out.categories.map((cat: any, cidx: number) => {\n        const tasks = Array.isArray(cat?.tasks) ? cat.tasks : [];\n        return {\n          key: String(cat?.id || cat?.key || `cat-${cidx + 1}`),\n          title: String(cat?.title || `Kategória ${cidx + 1}`),\n          pool: tasks.map((t: any, tidx: number) => {\n            const v = t?.variants || {};\n            return {\n              id: String(t?.id || `t${cidx + 1}-${tidx + 1}`),\n              title: String(t?.title || `Úloha ${tidx + 1}`),\n              metricKey: String(t?.metricKey || t?.id || `m_${cidx + 1}_${tidx + 1}`),\n              variants: [\n                { when: { lte: 33 }, text: String(v?.lte || \"\") },\n                { when: { between: [34, 66] }, text: String(v?.between || \"\") },\n                { when: { gte: 67 }, text: String(v?.gte || \"\") },\n              ],\n            };\n          }),\n        };\n      }),\n    };\n  }\n\n  if (!out.title || typeof out.title !== \"string\" || !out.title.trim()) {\n    if (Array.isArray(out.groups) && out.groups.length > 0) {\n      out.title = String(out.groups[0] || \"\").trim() || \"Generovaná edícia\";\n    } else if (Array.isArray(out.categories) && out.categories.length > 0) {\n      out.title = String(out.categories[0]?.title || \"\").trim() || \"Generovaná edícia\";\n    } else {\n      out.title = \"Generovaná edícia\";\n    }\n  }\n\n  if (!out.slug || typeof out.slug !== \"string\" || !out.slug.trim()) {\n    out.slug = slugify(out.title || \"generated-edition\");\n  }\n\n  if (!out.content || typeof out.content !== \"object\" || Array.isArray(out.content)) {\n    out.content = fallbackContent(String(out.title || out.slug || \"Edícia\"));\n  }\n\n  if (!out.engine || typeof out.engine !== \"object\") {\n    out.engine = { subject: String(out.slug || \"edition\").replace(/-/g, \"_\"), locale: \"sk\" };\n  }\n\n  // ---- tasks schema hardening (accept aliases + multiple task shapes) ----\n  if (out.tasks && Array.isArray(out.tasks.categories)) {\n    const clampInt = (n: any, lo: number, hi: number, fallback: number) => {\n      const x = Number(n);\n      if (!Number.isFinite(x)) return fallback;\n      return Math.max(lo, Math.min(hi, Math.floor(x)));\n    };\n\n    const toText = (x: any) => String(x ?? \"\").trim();\n\n    const pad3 = (arr: string[]) => {\n      const a = arr.filter(Boolean);\n      if (a.length === 0) return [\"\", \"\", \"\"]; \n      while (a.length < 3) a.push(a[a.length - 1]);\n      return a.slice(0, 3);\n    };\n\n    const normalizeVariantTriplet = (variantsAny: any, title: string): Array<{ when: any; text: string }> => {\n      // Allowed input shapes:\n      // 1) [{when:{lte|between|gte}, text:\"...\"}, ...] (already final)\n      // 2) [\"text1\",\"text2\",\"text3\"] (simple)\n      // 3) { lte:\"\", between:\"\", gte:\"\" } (legacy object)\n      if (Array.isArray(variantsAny) && variantsAny.every((v) => typeof v?.when === \"object\" && typeof v?.text === \"string\")) {\n        const vv = variantsAny.slice(0, 3);\n        if (vv.length === 3) return vv;\n      }\n\n      let texts: string[] = [];\n      if (Array.isArray(variantsAny)) {\n        texts = variantsAny.map(toText);\n      } else if (variantsAny && typeof variantsAny === \"object\") {\n        texts = [toText(variantsAny.lte), toText(variantsAny.between), toText(variantsAny.gte)];\n      }\n\n      const base = toText(title) || \"Task\";\n      const [a, b, c] = pad3(texts.length ? texts : [base, base, base]);\n\n      return [\n        { when: { lte: 33 }, text: a || base },\n        { when: { between: [34, 66] }, text: b || a || base },\n        { when: { gte: 67 }, text: c || b || a || base },\n      ];\n    };\n\n    out.tasks = {\n      ...out.tasks,\n      // allow 1..5 (canonical pick range); compute mirrors this clamp\n      pickPerCategory: clampInt(out.tasks.pickPerCategory, 1, 5, 3),\n      categories: out.tasks.categories.map((cat: any, cidx: number) => {\n        const key = String(cat?.key || cat?.id || `cat-${cidx + 1}`);\n        const title = String(cat?.title || `Kategória ${cidx + 1}`);\n\n        // accept both `pool` and legacy `tasks`\n        const rawPool = Array.isArray(cat?.pool) ? cat.pool : Array.isArray(cat?.tasks) ? cat.tasks : [];\n\n        const pool = rawPool.map((t: any, tidx: number) => {\n          // accept task as string\n          if (typeof t === \"string\") {\n            const txt = toText(t);\n            return {\n              id: `t${cidx + 1}-${tidx + 1}`,\n              title: txt || `Task ${tidx + 1}`,\n              metricKey: `m_${cidx + 1}_${tidx + 1}`,\n              variants: normalizeVariantTriplet([txt], txt || `Task ${tidx + 1}`),\n            };\n          }\n\n          // accept object (or even variants-only array)\n          const taskTitle = String(t?.title ?? t?.name ?? t?.text ?? `Task ${tidx + 1}`);\n          const variantsIn = (t && typeof t === \"object\" && \"variants\" in t) ? (t as any).variants : t;\n\n          return {\n            id: String(t?.id || `t${cidx + 1}-${tidx + 1}`),\n            title: String(taskTitle),\n            metricKey: String(t?.metricKey || `m_${cidx + 1}_${tidx + 1}`),\n            variants: normalizeVariantTriplet(variantsIn, taskTitle),\n          };\n        });\n\n        return { key, title, pool };\n      }),\n    };\n  }\n\n  return out;\n}\n\n\n// ---- tolerant JSON extractor (LLM-proof) ----\nfunction extractFirstJsonObject(input: string): string | null {\n  const s = String(input ?? \"\");\n  const start = s.indexOf(\"{\");\n  if (start < 0) return null;\n\n  let inStr = false;\n  let esc = false;\n  let depth = 0;\n\n  for (let i = start; i < s.length; i++) {\n    const ch = s[i];\n\n    if (inStr) {\n      if (esc) { esc = false; continue; }\n      if (ch === \"\\\\\") { esc = true; continue; }\n      if (ch === '\"') { inStr = false; continue; }\n      continue;\n    } else {\n      if (ch === '\"') { inStr = true; continue; }\n      if (ch === \"{\") depth++;\n      if (ch === \"}\") {\n        depth--;\n        if (depth === 0) {\n          const candidate = s.slice(start, i + 1).trim();\n          try {\n            JSON.parse(candidate);\n            return candidate;\n          } catch {\n            // if this candidate is not parseable, keep scanning (rare but possible)\n          }\n        }\n      }\n    }\n  }\n  return null;\n}\n// ---- end tolerant JSON extractor ----\n\nexport function normalizeEditionJsonRaw(raw: string) {\n  const base = sanitizeRaw(raw);\n  const noFence = unwrapCodeFence(base);\n  return extractJSONObject(noFence).trim();\n}\n\n\nexport function normalizeEditionJsonForBuilder(raw: string) {\n  let normalized = normalizeEditionJsonRaw(raw);\n  try {\n    const parsed = JSON.parse(normalized);\n    const shaped = normalizeFixture(parsed);\n    return JSON.stringify(shaped, null, 2);\n  } catch {\n  // If LLM returned JSON plus junk/trailing braces/text, extract the first valid JSON object\n  const extracted = extractFirstJsonObject(normalized);\n    return (extracted ?? normalized);\n  }\n}\n\n\nexport function validateEditionJson(raw: string, existingSlugs: string[] = []) {\n  let normalized = normalizeEditionJsonRaw(raw);\n  let obj: any;\n\n  try {\n    obj = JSON.parse(normalized);\n    // tolerate multiple task input shapes (string / simple variants / full V2)\n    normalizeTasksToV2(obj);\n  } catch (e: any) {\n\nreturn {\n      ok: false as const,\n      error: \"INVALID_JSON\",\n      details: String(e?.message ?? e),\n      debug: {\n        rawStart: String(raw ?? \"\").slice(0, 120),\n        normalizedStart: normalized.slice(0, 120),\n        foundRootKeys: [],\n      },\n    };\n  }\n\n  obj = normalizeFixture(obj);\n  const foundRootKeys = obj && typeof obj === \"object\" && !Array.isArray(obj) ? Object.keys(obj) : [];\n\n  if (!obj || typeof obj !== \"object\" || Array.isArray(obj)) {\n    return { ok: false as const, error: \"NOT_OBJECT\", debug: { foundRootKeys, normalizedStart: normalized.slice(0, 120) } };\n  }\n  if (typeof obj.slug !== \"string\" || !obj.slug.trim()) {\n    return { ok: false as const, error: \"MISSING_SLUG\", debug: { foundRootKeys, normalizedStart: normalized.slice(0, 120) } };\n  }\n  if (typeof obj.title !== \"string\" || !obj.title.trim()) {\n    return { ok: false as const, error: \"MISSING_TITLE\", debug: { foundRootKeys, normalizedStart: normalized.slice(0, 120) } };\n  }\n  if (!obj.content || typeof obj.content !== \"object\" || Array.isArray(obj.content)) {\n    return { ok: false as const, error: \"MISSING_CONTENT_OBJECT\", debug: { foundRootKeys, normalizedStart: normalized.slice(0, 120) } };\n  }\n\n  const slug = obj.slug.trim();\n  if (!/^[a-z0-9][a-z0-9-]{1,62}[a-z0-9]$/.test(slug)) {\n    return { ok: false as const, error: \"BAD_SLUG\", details: slug, debug: { foundRootKeys, normalizedStart: normalized.slice(0, 120) } };\n  }\n  if (existingSlugs.includes(slug)) {\n    return { ok: false as const, error: \"DUPLICATE_SLUG\", details: slug, debug: { foundRootKeys, normalizedStart: normalized.slice(0, 120) } };\n  }\n\n  // ---- tasks validation (if present) ----\n  if (obj.tasks !== undefined) {\n    const tasks = obj.tasks;\n    if (!tasks || typeof tasks !== \"object\" || Array.isArray(tasks)) {\n      return { ok: false as const, error: \"TASKS_NOT_OBJECT\", debug: { foundRootKeys } };\n    }\n\n    // allow any sane number; compute/UI will clamp as needed\n    const pick = Number((tasks as any).pickPerCategory ?? 3);\n    if (!Number.isFinite(pick) || pick < 1 || pick > 5) {\n      return { ok: false as const, error: \"TASKS_PICK_OUT_OF_RANGE\", details: (tasks as any).pickPerCategory, debug: { foundRootKeys } };\n    }\n\n    if (!Array.isArray(tasks.categories) || tasks.categories.length !== 5) {\n      return { ok: false as const, error: \"TASKS_NOT_5_CATEGORIES\", details: Array.isArray(tasks.categories) ? tasks.categories.length : null, debug: { foundRootKeys } };\n    }\n\n    for (let ci = 0; ci < tasks.categories.length; ci++) {\n      const cat = tasks.categories[ci];\n      const pool = Array.isArray(cat?.pool) ? cat.pool : Array.isArray(cat?.tasks) ? cat.tasks : null;\n      if (!Array.isArray(pool)) {\n        return { ok: false as const, error: \"CATEGORY_POOL_MISSING\", details: `cat#${ci + 1}`, debug: { foundRootKeys } };\n      }\n      const minPool = Math.max(5, Math.floor(pick));\n      if (pool.length < minPool) {\n        return { ok: false as const, error: \"CATEGORY_POOL_TOO_SMALL\", details: `cat#${ci + 1} len=${pool.length} (min ${minPool})`, debug: { foundRootKeys } };\n      }\n\n      for (let ti = 0; ti < pool.length; ti++) {\n        const tsk = pool[ti];\n        if (typeof tsk?.id !== \"string\" || !tsk.id.trim()) return { ok: false as const, error: \"TASK_ID_MISSING\", details: `cat#${ci + 1} task#${ti + 1}` };\n        if (typeof tsk?.title !== \"string\" || !tsk.title.trim()) return { ok: false as const, error: \"TASK_TITLE_MISSING\", details: `cat#${ci + 1} task#${ti + 1}` };\n        if (typeof tsk?.metricKey !== \"string\" || !tsk.metricKey.trim()) return { ok: false as const, error: \"TASK_METRICKEY_MISSING\", details: `cat#${ci + 1} task#${ti + 1}` };\n\n        const variants = Array.isArray(tsk?.variants) ? tsk.variants : null;\n        if (!variants || variants.length !== 3) return { ok: false as const, error: \"TASK_VARIANTS_NOT_3\", details: `cat#${ci + 1} task#${ti + 1}` };\n\n        const hasLte = variants.some((v: any) => typeof v?.when?.lte === \"number\" && typeof v?.text === \"string\");\n        const hasBetween = variants.some((v: any) => Array.isArray(v?.when?.between) && v.when.between.length === 2 && typeof v?.text === \"string\");\n        const hasGte = variants.some((v: any) => typeof v?.when?.gte === \"number\" && typeof v?.text === \"string\");\n\n        if (!hasLte || !hasBetween || !hasGte) {\n          return { ok: false as const, error: \"TASK_VARIANTS_BAD_SHAPE\", details: `cat#${ci + 1} task#${ti + 1}` };\n        }\n      }\n    }\n  }\n\n\n\n  return { ok: true as const, obj: { ...obj, slug, title: obj.title.trim() } as EditionPayload };\n}\n"],"names":[],"mappings":"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"}