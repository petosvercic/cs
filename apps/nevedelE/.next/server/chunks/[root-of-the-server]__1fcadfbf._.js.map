{"version":3,"sources":["../../../../../apps/nevedelE/lib/editions-store.ts"],"sourcesContent":["import fs from \"node:fs\";\nimport path from \"node:path\";\n\nexport type EditionIndexEntry = { slug: string; title: string; createdAt?: string; updatedAt?: string };\nexport type EditionDocument = {\n  slug: string;\n  title: string;\n  createdAt?: string;\n  updatedAt?: string;\n  engine?: { subject?: string; locale?: \"sk\" | \"cz\" | \"en\" };\n  content?: Record<string, any>;\n  tasks?: any;\n};\n\nfunction readJsonNoBom(filePath: string) {\n  return JSON.parse(fs.readFileSync(filePath, \"utf8\").replace(/^\\uFEFF/, \"\"));\n}\n\nfunction resolveDataRoot() {\n  const cwd = process.cwd();\n  const envRoot = (process.env.EDITIONS_ROOT || \"\").trim();\n  const roots = [\n    ...(envRoot ? [envRoot] : []),\n    cwd,\n    path.resolve(cwd, \"..\"),\n    path.resolve(cwd, \"..\", \"..\"),\n  ];\n\n  for (const root of roots) {\n    const direct = path.join(root, \"data\", \"editions.json\");\n    if (fs.existsSync(direct)) return path.join(root, \"data\");\n\n    const appScoped = path.join(root, \"apps\", \"nevedelE\", \"data\", \"editions.json\");\n    if (fs.existsSync(appScoped)) return path.join(root, \"apps\", \"nevedelE\", \"data\");\n  }\n\n  return path.join(cwd, \"data\");\n}\n\nexport function getDataPaths() {\n  const dataRoot = resolveDataRoot();\n  return {\n    dataRoot,\n    indexPath: path.join(dataRoot, \"editions.json\"),\n    editionsDir: path.join(dataRoot, \"editions\"),\n  };\n}\n\nexport function persistEditionLocally(edition: EditionDocument): void {\n  const { indexPath, editionsDir } = getDataPaths();\n  fs.mkdirSync(editionsDir, { recursive: true });\n\n  const now = new Date().toISOString();\n  const normalizedEdition = { ...edition, createdAt: edition.createdAt || now, updatedAt: edition.updatedAt || now };\n\n  const edPath = path.join(editionsDir, `${edition.slug}.json`);\n  fs.writeFileSync(edPath, JSON.stringify(normalizedEdition, null, 2) + \"\\n\", \"utf8\");\n\n  let idx: { editions: EditionIndexEntry[] } = { editions: [] };\n  if (fs.existsSync(indexPath)) {\n    idx = readJsonNoBom(indexPath);\n  }\n  if (!Array.isArray(idx.editions)) idx.editions = [];\n\n  const existingIndex = idx.editions.findIndex((e) => e?.slug === edition.slug);\n  if (existingIndex === -1) {\n    idx.editions.unshift({\n      slug: edition.slug,\n      title: edition.title,\n      createdAt: normalizedEdition.createdAt,\n      updatedAt: normalizedEdition.updatedAt\n    });\n  } else {\n    idx.editions[existingIndex] = {\n      ...idx.editions[existingIndex],\n      slug: edition.slug,\n      title: edition.title,\n      createdAt: idx.editions[existingIndex]?.createdAt || normalizedEdition.createdAt,\n      updatedAt: normalizedEdition.updatedAt\n    };\n  }\n\n  fs.writeFileSync(indexPath, JSON.stringify(idx, null, 2) + \"\\n\", \"utf8\");\n}\n\nexport function listEditions(): EditionIndexEntry[] {\n  const { indexPath, editionsDir } = getDataPaths();\n\n  try {\n    const idx = readJsonNoBom(indexPath);\n    if (Array.isArray(idx?.editions)) {\n      return idx.editions\n        .filter((e: any) => e && typeof e.slug === \"string\" && typeof e.title === \"string\")\n        .map((e: any) => ({ slug: e.slug, title: e.title, createdAt: e.createdAt, updatedAt: e.updatedAt }));\n    }\n  } catch {\n    // fallback below\n  }\n\n  if (!fs.existsSync(editionsDir)) return [];\n\n  return fs\n    .readdirSync(editionsDir)\n    .filter((name) => name.endsWith(\".json\"))\n    .map((name) => {\n      const doc = readJsonNoBom(path.join(editionsDir, name));\n      return {\n        slug: String(doc.slug || name.replace(/\\.json$/, \"\")),\n        title: String(doc.title || doc.slug || name),\n        createdAt: typeof doc.createdAt === \"string\" ? doc.createdAt : undefined,\n        updatedAt: typeof doc.updatedAt === \"string\" ? doc.updatedAt : undefined,\n      } as EditionIndexEntry;\n    });\n}\n\nexport function loadEditionBySlug(slug: string): EditionDocument | null {\n  const safeSlug = String(slug || \"\").trim();\n  if (!safeSlug) return null;\n\n  const { editionsDir } = getDataPaths();\n  const filePath = path.join(editionsDir, `${safeSlug}.json`);\n  if (!fs.existsSync(filePath)) return null;\n\n  try {\n    return readJsonNoBom(filePath) as EditionDocument;\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":"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"}